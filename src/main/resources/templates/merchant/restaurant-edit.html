<!DOCTYPE html>
<html lang="zh-Hant" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title th:text="'編輯餐廳 - ' + ${restaurant.name}">編輯餐廳</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .time-row{display:flex;gap:.5rem;align-items:center;margin-bottom:.5rem}
    .time-row .form-control,.time-row .form-select{width:auto}
  </style>
</head>
<body class="container py-4">
  <h3 class="mb-3" th:text="'編輯餐廳 - ' + ${restaurant.name}">編輯餐廳</h3>

  <div th:if="${msg}" class="alert alert-success" th:text="${msg}"></div>
  <div th:if="${error}" class="alert alert-danger" th:text="${error}"></div>

  <form th:action="@{|/merchant/restaurant/edit/${restaurant.id}|}" method="post">
    <!-- 基本欄位 -->
    <div class="mb-2">
      <label class="form-label">店名</label>
      <input class="form-control" name="name" th:value="${restaurant.name}" required>
    </div>
    <div class="mb-2">
      <label class="form-label">電話</label>
      <input class="form-control" name="phone" th:value="${restaurant.phone}">
    </div>
    <div class="mb-2">
      <label class="form-label">地址</label>
      <input class="form-control" name="address" th:value="${restaurant.address}">
    </div>
    <div class="mb-2">
      <label class="form-label">縣市</label>
      <input class="form-control" name="county" th:value="${restaurant.county}">
    </div>
    <div class="mb-2">
      <label class="form-label">分類（多選請按住 Ctrl/⌘）</label>
      <input class="form-control" name="type" th:value="${restaurant.type}">
    </div>
    <div class="mb-2">
      <label class="form-label">關鍵字（逗號分隔）</label>
      <input class="form-control" name="keywords" th:value="${restaurant.keywords}">
    </div>

    <!-- ========= 營業時間 ========= -->
    <h5 class="mt-4">營業時間</h5>
    <p class="text-muted">同一天可新增多段；勾「公休」則忽略時間。</p>

    <div id="weekly-container">
      <!-- 1) 既有時段 -->
      <div class="time-row" th:each="h : ${weeklyHoursEntities}">
        <select name="dayOfWeek" class="form-select" th:value="${h.dayOfWeek}">
          <option value="MONDAY">週一</option>
          <option value="TUESDAY">週二</option>
          <option value="WEDNESDAY">週三</option>
          <option value="THURSDAY">週四</option>
          <option value="FRIDAY">週五</option>
          <option value="SATURDAY">週六</option>
          <option value="SUNDAY">週日</option>
        </select>

        <label>開</label>
        <input type="time" name="openTime" class="form-control" th:value="${h.openTime}" th:disabled="${h.closedAllDay}">
        <label>關</label>
        <input type="time" name="closeTime" class="form-control" th:value="${h.closeTime}" th:disabled="${h.closedAllDay}">

        <!-- hidden+checkbox：確保陣列長度對齊 -->
        <input type="hidden" name="closedAllDay" th:value="${h.closedAllDay ? 'true' : 'false'}">
        <div class="form-check ms-1">
          <input class="form-check-input" type="checkbox" name="closedAllDay" value="true"
                 th:checked="${h.closedAllDay}" onchange="toggleRow(this)">
          <label class="form-check-label">公休</label>
        </div>

        <button type="button" class="btn btn-sm btn-outline-secondary ms-2" onclick="addRow(this)">新增一段</button>
        <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeRow(this)">刪除</button>
      </div>

      <!-- 2) 若目前沒有任何時段，給一行空白 -->
      <div class="time-row" th:if="${weeklyHoursEntities == null or #lists.isEmpty(weeklyHoursEntities)}">
        <select name="dayOfWeek" class="form-select">
          <option value="MONDAY">週一</option>
          <option value="TUESDAY">週二</option>
          <option value="WEDNESDAY">週三</option>
          <option value="THURSDAY">週四</option>
          <option value="FRIDAY">週五</option>
          <option value="SATURDAY">週六</option>
          <option value="SUNDAY">週日</option>
        </select>

        <label>開</label><input type="time" name="openTime" class="form-control">
        <label>關</label><input type="time" name="closeTime" class="form-control">

        <input type="hidden" name="closedAllDay" value="false">
        <div class="form-check ms-1">
          <input class="form-check-input" type="checkbox" name="closedAllDay" value="true" onchange="toggleRow(this)">
          <label class="form-check-label">公休</label>
        </div>

        <button type="button" class="btn btn-sm btn-outline-secondary ms-2" onclick="addRow(this)">新增一段</button>
        <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeRow(this)">刪除</button>
      </div>
    </div>

    <div class="mt-4 text-end">
      <button class="btn btn-primary" type="submit">儲存並重新送審</button>
      <a th:href="@{|/restaurant-detail?id=${restaurant.id}|}" class="btn btn-outline-secondary">回詳細頁</a>
    </div>
  </form>

<script>
function addRow(btn){
  const row=btn.closest('.time-row'); const clone=row.cloneNode(true);
  clone.querySelectorAll('input[type=time]').forEach(i=>{i.value='';i.disabled=false;});
  const cbs=clone.querySelectorAll('input[name=closedAllDay]');
  cbs.forEach((el,idx)=>{ if(idx===0){el.value='false';el.type='hidden';} else {el.type='checkbox';el.checked=false;}});
  row.parentNode.appendChild(clone);
}
function removeRow(btn){
  const container=document.getElementById('weekly-container');
  const rows=container.querySelectorAll('.time-row');
  if(rows.length>1) btn.closest('.time-row').remove();
}
function toggleRow(cb){
  const row=cb.closest('.time-row');
  const times=row.querySelectorAll('input[type=time]');
  if(cb.checked){ times.forEach(i=>{i.value='';i.disabled=true;}); }
  else{ times.forEach(i=>i.disabled=false); }
}
</script>
</body>
</html>
