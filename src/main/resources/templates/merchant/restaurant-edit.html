<!DOCTYPE html>
<html lang="zh-Hant" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>編輯餐廳（商家）</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="container py-4">
  <div th:replace="~{layout/navbar}"></div>

  <h2 class="mb-3">編輯餐廳資料（商家）</h2>

  <div th:if="${msg}" class="alert alert-success" th:text="${msg}"></div>
  <div th:if="${error}" class="alert alert-danger" th:text="${error}"></div>

  <!-- ============== 基本資料（與新增同款） ============== -->
  <form th:action="@{|/merchant/restaurant/edit/${restaurant.id}|}" method="post" class="mb-5" enctype="multipart/form-data">
    <div class="mb-3">
      <label class="form-label">店名</label>
      <input type="text" class="form-control" name="name" required th:value="${restaurant.name}">
    </div>

    <div class="mb-3">
      <label class="form-label">地址</label>
      <input type="text" class="form-control" name="address" required th:value="${restaurant.address}">
    </div>

    <div class="mb-3">
      <label class="form-label">電話</label>
      <input type="text" class="form-control" name="phone" th:value="${restaurant.phone}">
    </div>

    <div class="mb-3">
      <label class="form-label">縣市</label>
      <select class="form-select" name="county" required>
        <option value="">請選擇</option>
        <option th:each="c : ${#lists.arrayList('台北市','新北市','基隆市','桃園市','新竹市','新竹縣','苗栗縣','台中市','彰化縣','南投縣','雲林縣','嘉義市','嘉義縣','台南市','高雄市','屏東縣','台東縣','花蓮縣','宜蘭縣','澎湖縣','金門縣','連江縣')}"
                th:value="${c}"
                th:text="${c}"
                th:selected="${c == restaurant.county}">
        </option>
      </select>
    </div>

    <div class="mb-3">
      <label class="form-label">分類（可複選）</label><br>
      <th:block th:with="selected=${restaurant.type} == null ? '' : ${restaurant.type}">
        <div class="form-check form-check-inline" th:each="opt : ${#lists.arrayList('早餐','早午餐','午餐','下午茶','小吃','晚餐','甜點','冰品','銅板美食')}">
          <input class="form-check-input" type="checkbox" name="type" th:value="${opt}"
                 th:checked="${selected.contains(opt)}">
          <label class="form-check-label" th:text="${opt}"></label>
        </div>
      </th:block>
    </div>

    <div class="mb-3">
      <label class="form-label">關鍵字（空格分隔）</label>
      <input type="text" class="form-control" name="keywords" placeholder="小籠包 餡餅 排隊"
             th:value="${restaurant.keywords}">
    </div>

    <!-- 照片維持原有行為（此處可視需要加上替換照片功能） -->
    <div class="mb-3">
      <label class="form-label">店家照片（最多 5 張）</label>
      <input type="file" class="form-control" name="photos" multiple accept="image/*">
      <div class="form-text">支援多檔上傳，僅儲存前 5 張。</div>
    </div>

    <div class="d-flex gap-2">
      <button type="submit" class="btn btn-primary">送出（進入審核）</button>
      <a class="btn btn-outline-secondary" th:href="@{/merchant/restaurant/mine}">回我的餐廳</a>
      <form th:action="@{|/merchant/restaurant/resubmit/${restaurant.id}|}" method="post" class="d-inline">
        <button type="submit" class="btn btn-outline-warning">不改內容，直接重新送審</button>
      </form>
    </div>
  </form>

  <!-- ============== 每週營業時間（整表覆蓋） ============== -->
  <h4 class="mt-4">每週營業時間</h4>
  <form th:action="@{|/merchant/restaurant/${restaurant.id}/hours|}" method="post" class="mb-5">
    <div class="table-responsive">
      <table class="table table-sm align-middle">
        <thead>
          <tr>
            <th style="width:140px">星期</th>
            <th style="width:180px">開門 (HH:mm)</th>
            <th style="width:180px">打烊 (HH:mm)</th>
            <th style="width:140px">整天公休</th>
          </tr>
        </thead>
        <tbody>
          <tr th:each="row,idxStat : ${#lists.arrayList('MONDAY','TUESDAY','WEDNESDAY','THURSDAY','FRIDAY','SATURDAY','SUNDAY')}">
            <td>
              <input type="hidden" name="dow" th:value="${row}">
              <span th:text="${#strings.replace(row,'DAY','  ')}"></span>
            </td>
            <td><input type="time" class="form-control" name="open"></td>
            <td><input type="time" class="form-control" name="close"></td>
            <!-- 勾選就會送出該列的索引值（用來還原是哪一天） -->
            <td class="text-center">
              <input class="form-check-input" type="checkbox" name="closed"
                     th:value="${idxStat.index}">
            </td>
          </tr>
        </tbody>
      </table>
    </div>
    <button type="submit" class="btn btn-success">儲存每週營業時間</button>
  </form>

  <!-- ============== 特例（單日店休 / 特殊時段） ============== -->
  <h4 class="mt-4">特例（單日店休 / 特殊時段）</h4>
  <form th:action="@{|/merchant/restaurant/${restaurant.id}/special-hour|}" method="post" class="border rounded p-3">
    <div class="row g-3 align-items-end">
      <div class="col-md-3">
        <label class="form-label">日期</label>
        <input type="date" class="form-control" name="date" required>
      </div>
      <div class="col-md-3">
        <label class="form-label">開門</label>
        <input type="time" class="form-control" name="open" placeholder="例如 10:00">
      </div>
      <div class="col-md-3">
        <label class="form-label">打烊</label>
        <input type="time" class="form-control" name="close" placeholder="例如 20:00">
      </div>
      <div class="col-md-3">
        <div class="form-check mt-4">
          <input class="form-check-input" type="checkbox" id="closedAllDay" name="closedAllDay">
          <label class="form-check-label" for="closedAllDay">整天公休</label>
        </div>
      </div>
      <div class="col-12">
        <label class="form-label">備註（選填）</label>
        <input type="text" class="form-control" name="note" placeholder="端午節公休 / 臨時店休等">
      </div>
    </div>
    <div class="mt-3">
      <button type="submit" class="btn btn-success">新增/更新 特例</button>
    </div>
  </form>

  <script>
    // UX：勾選「整天公休」時，清空並禁用時段欄位
    const closedAllDay = document.getElementById('closedAllDay');
    if (closedAllDay) {
      const open = document.querySelector('form[action$="special-hour"] input[name="open"]');
      const close = document.querySelector('form[action$="special-hour"] input[name="close"]');
      const toggle = () => {
        const dis = closedAllDay.checked;
        open.value = '';
        close.value = '';
        open.disabled = dis;
        close.disabled = dis;
      };
      closedAllDay.addEventListener('change', toggle);
      toggle();
    }
  </script>
</body>
</html>
